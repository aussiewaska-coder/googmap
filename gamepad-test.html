<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamepad Map Control Test</title>
    <link href="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@4/dist/maplibre-gl.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Crosshairs */
        #crosshairs {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            pointer-events: none;
            z-index: 1000;
        }

        #crosshairs::before,
        #crosshairs::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
        }

        #crosshairs::before {
            top: 0;
            left: 50%;
            width: 1px;
            height: 100%;
        }

        #crosshairs::after {
            left: 0;
            top: 50%;
            width: 100%;
            height: 1px;
        }

        /* Status Panel */
        #status {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            color: white;
            max-width: 400px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        #status h1 {
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #status .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            transition: background 0.3s;
        }

        #status .indicator.connected {
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        #status-text {
            padding: 12px;
            background: rgba(234, 179, 8, 0.1);
            border: 1px solid rgba(234, 179, 8, 0.2);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        #status-text.connected {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.2);
        }

        #controls {
            display: none;
            font-size: 12px;
        }

        #controls.visible {
            display: block;
        }

        #controls h3 {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.6;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #controls .control-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        #controls .control-item:last-child {
            border-bottom: none;
        }

        #controls .control-label {
            opacity: 0.5;
        }

        /* Camera Info */
        #camera-info {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            color: white;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        #camera-info h3 {
            color: #60a5fa;
            font-weight: bold;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        #camera-info .info-item {
            display: flex;
            justify-content: space-between;
            gap: 24px;
            padding: 4px 0;
        }

        #camera-info .label {
            opacity: 0.5;
        }

        #camera-info .value {
            font-weight: bold;
        }

        /* Instructions */
        #instructions {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            z-index: 999;
            pointer-events: none;
        }

        #instructions.hidden {
            display: none;
        }

        #instructions svg {
            width: 64px;
            height: 64px;
            opacity: 0.2;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="crosshairs"></div>

    <div id="status">
        <h1>
            <span class="indicator" id="indicator"></span>
            Gamepad Map Control
        </h1>
        <div id="status-text">Press a button on your gamepad to begin...</div>
        <div id="controls">
            <h3>Controls</h3>
            <div class="control-item">
                <span class="control-label">Left Stick:</span>
                <span>Pan map</span>
            </div>
            <div class="control-item">
                <span class="control-label">Right Stick Y:</span>
                <span>Zoom in/out</span>
            </div>
            <div class="control-item">
                <span class="control-label">Right Stick X:</span>
                <span>Rotate bearing</span>
            </div>
            <div class="control-item">
                <span class="control-label">L2/R2 Triggers:</span>
                <span>Tilt pitch</span>
            </div>
            <div class="control-item">
                <span class="control-label">A Button:</span>
                <span>Reset view to Australia</span>
            </div>
        </div>
    </div>

    <div id="camera-info">
        <h3>Camera</h3>
        <div class="info-item">
            <span class="label">Lat:</span>
            <span class="value" id="lat">-25.2744°</span>
        </div>
        <div class="info-item">
            <span class="label">Lng:</span>
            <span class="value" id="lng">133.7751°</span>
        </div>
        <div class="info-item">
            <span class="label">Zoom:</span>
            <span class="value" id="zoom" style="color: #60a5fa">4.00</span>
        </div>
        <div class="info-item">
            <span class="label">Pitch:</span>
            <span class="value" id="pitch" style="color: #22c55e">0°</span>
        </div>
        <div class="info-item">
            <span class="label">Bearing:</span>
            <span class="value" id="bearing" style="color: #eab308">0°</span>
        </div>
    </div>

    <div id="instructions">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="7" width="20" height="10" rx="2"/>
            <circle cx="6" cy="12" r="2"/>
            <circle cx="18" cy="12" r="2"/>
        </svg>
        <div>Connect a gamepad to begin</div>
    </div>

    <script>
        // Initialize map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'esri-imagery': {
                        type: 'raster',
                        tiles: [
                            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                        ],
                        tileSize: 256,
                        attribution: '© Esri'
                    }
                },
                layers: [{
                    id: 'esri-imagery-layer',
                    type: 'raster',
                    source: 'esri-imagery'
                }]
            },
            center: [133.7751, -25.2744], // Australia
            zoom: 4,
            pitch: 0,
            bearing: 0
        });

        map.addControl(new maplibregl.NavigationControl(), 'top-right');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

        // Update camera info display
        function updateCameraInfo() {
            const center = map.getCenter();
            document.getElementById('lat').textContent = center.lat.toFixed(4) + '°';
            document.getElementById('lng').textContent = center.lng.toFixed(4) + '°';
            document.getElementById('zoom').textContent = map.getZoom().toFixed(2);
            document.getElementById('pitch').textContent = map.getPitch().toFixed(0) + '°';
            document.getElementById('bearing').textContent = map.getBearing().toFixed(0) + '°';
        }

        map.on('move', updateCameraInfo);

        // Gamepad state
        let gamepadConnected = false;
        let gamepadIndex = null;

        // Gamepad connection events
        window.addEventListener('gamepadconnected', (e) => {
            console.log('Gamepad connected:', e.gamepad.id);
            gamepadConnected = true;
            gamepadIndex = e.gamepad.index;

            document.getElementById('indicator').classList.add('connected');
            document.getElementById('status-text').textContent = `Gamepad connected: ${e.gamepad.id}`;
            document.getElementById('status-text').classList.add('connected');
            document.getElementById('controls').classList.add('visible');
            document.getElementById('instructions').classList.add('hidden');
        });

        window.addEventListener('gamepaddisconnected', (e) => {
            console.log('Gamepad disconnected');
            gamepadConnected = false;
            gamepadIndex = null;

            document.getElementById('indicator').classList.remove('connected');
            document.getElementById('status-text').textContent = 'Gamepad disconnected. Reconnect to continue.';
            document.getElementById('status-text').classList.remove('connected');
            document.getElementById('controls').classList.remove('visible');
            document.getElementById('instructions').classList.remove('hidden');
        });

        // Utility function to scale and clamp joystick values
        function scaleClamp(value, scale, threshold) {
            return Math.abs(value) < threshold ? 0 : value * scale;
        }

        // Gamepad polling
        let zoomDiff = 0;
        let bearingDiff = 0;
        let pitchDiff = 0;
        let lastButtonStates = {};

        function pollGamepad() {
            if (gamepadIndex !== null) {
                const gamepads = navigator.getGamepads();
                const gamepad = gamepads[gamepadIndex];

                if (gamepad) {
                    // Left stick: Pan (axes 0 and 1)
                    const leftX = gamepad.axes[0] || 0;
                    const leftY = gamepad.axes[1] || 0;

                    // Right stick (axes 2 and 3)
                    const rightX = gamepad.axes[2] || 0;
                    const rightY = gamepad.axes[3] || 0;

                    // Pan speed scales with zoom level
                    const currentZoom = map.getZoom();
                    const panScale = (currentZoom / 30) * 100;

                    const panX = scaleClamp(leftX, panScale, 0.15);
                    const panY = scaleClamp(leftY, panScale, 0.15);

                    if (panX !== 0 || panY !== 0) {
                        map.panBy([panX, panY], { animate: false });
                    }

                    // Zoom control (right stick Y)
                    zoomDiff += scaleClamp(-rightY, 0.05, 0.15);
                    if (Math.abs(zoomDiff) > 0.1) {
                        const newZoom = currentZoom + zoomDiff;
                        map.setZoom(newZoom);
                        zoomDiff = 0;
                    }

                    // Bearing control (right stick X)
                    bearingDiff += scaleClamp(rightX, 2, 0.15);
                    if (Math.abs(bearingDiff) > 1) {
                        const currentBearing = map.getBearing();
                        map.setBearing(currentBearing + bearingDiff);
                        bearingDiff = 0;
                    }

                    // Pitch control (L2/R2 triggers - buttons 6 and 7)
                    const l2 = gamepad.buttons[6]?.pressed ? 1 : 0;
                    const r2 = gamepad.buttons[7]?.pressed ? 1 : 0;

                    if (l2 || r2) {
                        pitchDiff += (r2 - l2) * 1.5;
                        if (Math.abs(pitchDiff) > 1) {
                            const currentPitch = map.getPitch();
                            const newPitch = Math.max(0, Math.min(60, currentPitch + pitchDiff));
                            map.setPitch(newPitch);
                            pitchDiff = 0;
                        }
                    }

                    // A button (button 0) - Reset view (only on press, not hold)
                    const aButton = gamepad.buttons[0]?.pressed;
                    if (aButton && !lastButtonStates[0]) {
                        map.flyTo({
                            center: [133.7751, -25.2744],
                            zoom: 4,
                            pitch: 0,
                            bearing: 0,
                            duration: 2000
                        });
                    }
                    lastButtonStates[0] = aButton;
                }
            }

            requestAnimationFrame(pollGamepad);
        }

        // Start polling
        pollGamepad();

        // Check for already connected gamepads on page load
        window.addEventListener('load', () => {
            const gamepads = navigator.getGamepads();
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    // Trigger the connected event manually
                    window.dispatchEvent(new GamepadEvent('gamepadconnected', { gamepad: gamepads[i] }));
                    break;
                }
            }
        });
    </script>
</body>
</html>
